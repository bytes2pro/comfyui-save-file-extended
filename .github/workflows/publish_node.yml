name: üì¶ Publish to Comfy registry
on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (current: 0.0.3)"
        required: true
        type: string
  push:
    branches: [main]

permissions:
  contents: write
  issues: write
  workflows: write

jobs:
  publish-node:
    if: github.event_name == 'workflow_dispatch' || github.actor != 'github-actions[bot]'
    name: Publish Custom Node to registry
    runs-on: ubuntu-latest
    steps:
      - name: ‚ôªÔ∏è Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: üß≠ Ensure main branch (manual run)
        if: github.event_name == 'workflow_dispatch'
        shell: bash
        run: |
          set -euo pipefail
          git fetch origin main
          git checkout main
          git pull --ff-only origin main
      - name: üßÆ Normalize version input
        if: github.event_name == 'workflow_dispatch'
        shell: bash
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
        run: |
          set -euo pipefail
          version="${INPUT_VERSION}"
          version="${version/#v/}"
          version="${version/#V/}"

          if [[ -z "${version}" ]]; then
            echo "Version input cannot be empty." >&2
            exit 1
          fi

          if [[ ! "${version}" =~ ^[0-9]+(\.[0-9]+)*$ ]]; then
            echo "Version '${version}' is not in a numeric dotted format (e.g. 0.0.4)." >&2
            exit 1
          fi

          echo "RELEASE_VERSION=${version}" >> "$GITHUB_ENV"
      - name: üìù Update pyproject version (manual run)
        if: github.event_name == 'workflow_dispatch'
        shell: bash
        env:
          RELEASE_VERSION: ${{ env.RELEASE_VERSION }}
        run: |
          set -euo pipefail
          python .github/scripts/update_pyproject_version.py
      - name: üíæ Commit version bump (manual run)
        if: github.event_name == 'workflow_dispatch'
        shell: bash
        env:
          RELEASE_VERSION: ${{ env.RELEASE_VERSION }}
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet; then
            echo "No changes detected after version update; nothing to commit."
          else
            git add pyproject.toml .github/workflows/publish_node.yml
            git commit -m "chore: release v${RELEASE_VERSION}"
            git push origin HEAD:main
          fi
      - name: üîç Detect version change
        id: version_check
        shell: bash
        run: |
          set -euo pipefail
          python .github/scripts/detect_version_change.py
      - name: üöÄ Create release branch and tag
        if: steps.version_check.outputs.should_publish == 'true'
        id: create_refs
        shell: bash
        env:
          VERSION: ${{ steps.version_check.outputs.current_version }}
        run: |
          set -euo pipefail

          release_ref="v${VERSION}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git ls-remote --heads origin "${release_ref}" | grep -q "${release_ref}$"; then
            echo "Branch ${release_ref} already exists on origin; skipping branch creation."
          else
            echo "Pushing branch ${release_ref}"
            git push origin "HEAD:refs/heads/${release_ref}"
          fi

          if git ls-remote --tags origin "${release_ref}" | grep -q "${release_ref}$"; then
            echo "Tag ${release_ref} already exists on origin; skipping creation."
          else
            if git rev-parse "refs/tags/${release_ref}" >/dev/null 2>&1; then
              echo "Local tag ${release_ref} already exists; skipping local creation."
            else
              git tag "${release_ref}"
            fi
            git push origin "refs/tags/${release_ref}"
            echo "Created and pushed tag ${release_ref}."
          fi

          echo "release_ref=${release_ref}" >> "$GITHUB_OUTPUT"
      - name: üì¶ Publish Custom Node
        if: steps.version_check.outputs.should_publish == 'true'
        uses: Comfy-Org/publish-node-action@main
        with:
          personal_access_token: ${{ secrets.REGISTRY_ACCESS_TOKEN }}
      - name: ‚ÑπÔ∏è Release skipped
        if: steps.version_check.outputs.should_publish != 'true'
        run: echo "No version change detected; publish step skipped."
